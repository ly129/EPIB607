# source("bin/functions.R")
# rm(list=ls())
# source("bin/functions.R")
# source("bin/packages.R")
## ---- load-data ----

# did this step only once cause it takes a long time, but also gives the best results
# DT <- xlsx::read.xlsx("data/acs_nsqip_puf05-15_cdiff_excluded_emergencyasafeb 23.xlsx", sheetIndex = 1)
# saveRDS(DT, file = "data/acs_nsqip_puf05-15_cdiff_excluded_emergencyasafeb 23.rds")

# updated
# DT <- xlsx::read.xlsx("data/acs_nsqip_puf05-15_cdiff_emergencyrealTAC_May30_ASA3+.xlsx", sheetIndex = 1)
# saveRDS(DT, file = "data/acs_nsqip_puf05-15_cdiff_emergencyrealTAC_May30_ASA3+.rds")

# DT <- readRDS(file = "~/Dropbox/consulting/maria/data/acs_nsqip_puf05-15_cdiff_excluded_emergencyasafeb 23.rds")
DT <- readRDS(file = "~/Dropbox/consulting/maria/data/acs_nsqip_puf05-15_cdiff_emergencyrealTAC_May30_ASA3+.rds")
DT <- as.data.table(DT)

# Variables : (revised email from Maria, May 31, 2017) 
# I revised them now and you can use the variables below: 
#   -patient age: "numage" (column KV)  for age which we can divide into <50, 50-60, 60-70, 70-80, 80+
#   -preoperative intubation: preopventilat (LH)
# -Preoperative septic shock : "preopsepsis" LT (categorical variable) 
# -Preoperative dialysis dependence "preopdialysis" LM
# -Preoperative acute renal failure "preopaki" LL 
# -preoperative wbc count (usually as a categorical variable) : "prwbc" BE
# -preoperative creatinine  "prcreat" AZ
# -preoperative platelet count "prplate" BG
# -preoperative albumin (usually as a categorical variable) "pralbum" BA
# -preoperative immunosuppression (termed "steroid" in the variable) "fsteroid" LP
# The other thing we wanted to do is compare how our model does compared to the 
# mortality calculator of NSQIP that ("mortprcomb" column MV). 
# Age: Can be either <50, 50-60, >60 or <65 and 65 and over  
# (the highest risk factor in studies is age >75, but I see in our data that the eldest patient is 69)
# Albumin : Less than 1.5, 1.5 to 3, and 3 or more
# WBC : <4, 4-20, 20-49.9, 50 & above
# Preoperative Creatinine <1.13, 1.13 to 2.26, >=2.26
# platelets: <150, >=150

col.names <- c("CaseID","death",
               "numage",
               "prcreat",
               "preopaki", # acute renal failure (kidney injury) 
               "pralbum",
               "prwbc",
               "prplate", 
               "preopventilat", # preoperative intubation
               "fsteroid", # immunosuppression
               "preopsepsis", # shock
               "mortprcomb")
length(col.names)
all(col.names %in% colnames(DT))
rm.colnames <- colnames(DT)[colnames(DT) %ni% col.names]

DT[, (rm.colnames) := NULL]
DT$CaseID %>% unique() %>% length()
str(DT)


#' We can define redefine shock in the NSQIP database as: SHOCK=SEPTIC SHOCK and
#' NO SHOCK=No Shock, SIRS, or Sepsis. With this, the definitions of shock in
#' the orignial NSQIP database and the validation cohort will be the same.
DT[, table(death, useNA = "always")]
DT[, table(preopsepsis, useNA = "always")]
DT[preopsepsis %in% c(0,1,2), preopsepsis := 0]
DT[, table(preopsepsis, useNA = "always")]
DT[preopsepsis %in% c(3), preopsepsis := 1]
DT[, table(preopsepsis, useNA = "always")]

DT[, `:=`(deathn = death, 
          death = factor(death, levels = c(0,1), labels = c("Alive","Dead")),
          #preopdialysis = factor(preopdialysis, levels = c(0,1), labels = c("No Preop Dialysis","Preop Dialysis")),
          preopventilat = factor(preopventilat, levels = c(0,1), labels = c("Not Ventilated", "Ventilated")),
          preopsepsis = factor(preopsepsis, levels = c(0,1), labels = c("No Shock","Shock")),
          fsteroid = factor(fsteroid, levels = c(0,1), labels = c("Non-immunosuppressed","Immunosuppressed")),
          preopaki = factor(preopaki, levels = c(0,1), labels = c("No Preop Aki", "Preop Aki"))
)]

DT[, table(numage, useNA = "always")]
DT[is.na(numage), numage:=runif(.N, min = 89, max = 92)]
DT[, table(numage, useNA = "always")]
df <- as.data.frame(DT)
# md.pattern(df)
imp <- mice::mice(df, m = 1, maxit = 1)
# plot(imp)

# extract the data in long format
DT_imp <- as.data.table(complete(imp, action = "long", include = TRUE))
DT_imp[.imp==0][, table(prwbc, useNA = "always")]
DT_imp[.imp==1][, table(prwbc, useNA = "always")]

DT_imp <- DT_imp[.imp==1]


# attach(DT)
# label(preopsepsis) <- 'Preoperative Sepsis'
# label(fsteroid) <- 'Immunosuppressed'
# label(prcreat) <- 'Preoperative Creatinine (mg/dL)'
# label(prplate) <- 'Preoperative Platelets (x10^9/L)'
# label(numage) <- 'Age at operation (years)'
# 
# label(preopsepsis) <- 'Preoperative Sepsis'
# label(fsteroid) <- 'Immunosuppressed'
# label(prcreatf) <- 'Preoperative Creatinine (mg/dL)'
# label(prplatef) <- 'Preoperative Platelets (x10^9/L)'
# label(numagef) <- 'Age at operation (years)'

# y1 <- ylab(NULL)
# 
# continuous_var <- c("numage","prcreat","pralbum", "prwbc","prplate")
# marginal_plots <- vector("list",length = length(continuous_var))
# 
# p1 <- ggplot(df, aes(x = numage, y = deathn)) + 
#   Hmisc::histSpikeg(deathn ~ numage, lowess = TRUE, data = df) + 
#   ylim(0,1) + ylab(NULL)
# 
# # p2 <- ggplot(df, aes(x = numage, y = deathn, color = preopdialysis)) + 
# #   Hmisc::histSpikeg(deathn ~ numage + preopdialysis, lowess = TRUE, data = df) + 
# #   ylim(0,1) + y1 + 
# #   guides(col = guide_legend(nrow = 2)) + theme(legend.position = "bottom")
# 
# p3 <- ggplot(df, aes(x = numage, y = deathn, color = preopventilat)) + 
#   Hmisc::histSpikeg(deathn ~ numage + preopventilat, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + 
#   guides(col = guide_legend(nrow = 2))+ theme(legend.position = "bottom")
# 
# p4 <- ggplot(df, aes(x = numage, y = deathn, color = fsteroid)) + 
#   Hmisc::histSpikeg(deathn ~ numage + fsteroid, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + 
#   guides(col = guide_legend(nrow = 2))+ theme(legend.position = "bottom")
# 
# p5 <- ggplot(df, aes(x = numage, y = deathn, color = preopsepsis)) + 
#   Hmisc::histSpikeg(deathn ~ numage + preopsepsis, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + 
#   guides(col = guide_legend(nrow = 4))+ theme(legend.position = "bottom")
# 
# p6 <- ggplot(df, aes(x = numage, y = deathn, color = preopaki)) + 
#   Hmisc::histSpikeg(deathn ~ numage + preopaki, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + 
#   guides(col = guide_legend(nrow = 2))+ theme(legend.position = "bottom")
# 
# marginal_plots[[1]] <- cowplot::plot_grid(p1,p3,p4,p5,p6)
# marginal_plots[[1]]
# 
# p1 <- ggplot(df, aes(x = prcreat, y = deathn)) + 
#   Hmisc::histSpikeg(deathn ~ prcreat, lowess = TRUE, data = df) + 
#   ylim(0,1) + ylab(NULL)
# 
# # p2 <- ggplot(df, aes(x = prcreat, y = deathn, color = preopdialysis)) + 
# #   Hmisc::histSpikeg(deathn ~ prcreat + preopdialysis, lowess = TRUE, data = df) + 
# #   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
# #   guides(col = guide_legend(nrow = 2))
# 
# p3 <- ggplot(df, aes(x = prcreat, y = deathn, color = preopventilat)) + 
#   Hmisc::histSpikeg(deathn ~ prcreat + preopventilat, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# p4 <- ggplot(df, aes(x = prcreat, y = deathn, color = fsteroid)) + 
#   Hmisc::histSpikeg(deathn ~ prcreat + fsteroid, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# p5 <- ggplot(df, aes(x = prcreat, y = deathn, color = preopsepsis)) + 
#   Hmisc::histSpikeg(deathn ~ prcreat + preopsepsis, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 4))
# 
# p6 <- ggplot(df, aes(x = prcreat, y = deathn, color = preopaki)) + 
#   Hmisc::histSpikeg(deathn ~ prcreat + preopaki, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# marginal_plots[[2]] <- cowplot::plot_grid(p1,p3,p4,p5,p6)
# 
# 
# p1 <- ggplot(df, aes(x = pralbum, y = deathn)) + 
#   Hmisc::histSpikeg(deathn ~ pralbum, lowess = TRUE, data = df) + 
#   ylim(0,1) + ylab(NULL)
# 
# # p2 <- ggplot(df, aes(x = pralbum, y = deathn, color = preopdialysis)) + 
# #   Hmisc::histSpikeg(deathn ~ pralbum + preopdialysis, lowess = TRUE, data = df) + 
# #   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
# #   guides(col = guide_legend(nrow = 2))
# 
# p3 <- ggplot(df, aes(x = pralbum, y = deathn, color = preopventilat)) + 
#   Hmisc::histSpikeg(deathn ~ pralbum + preopventilat, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# p4 <- ggplot(df, aes(x = pralbum, y = deathn, color = fsteroid)) + 
#   Hmisc::histSpikeg(deathn ~ pralbum + fsteroid, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# p5 <- ggplot(df, aes(x = pralbum, y = deathn, color = preopsepsis)) + 
#   Hmisc::histSpikeg(deathn ~ pralbum + preopsepsis, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 4))
# 
# p6 <- ggplot(df, aes(x = pralbum, y = deathn, color = preopaki)) + 
#   Hmisc::histSpikeg(deathn ~ pralbum + preopaki, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# marginal_plots[[3]] <- cowplot::plot_grid(p1,p3,p4,p5,p6)
# 
# 
# p1 <- ggplot(df, aes(x = prwbc, y = deathn)) + 
#   Hmisc::histSpikeg(deathn ~ prwbc, lowess = TRUE, data = df) + 
#   ylim(0,1) + ylab(NULL)
# 
# # p2 <- ggplot(df, aes(x = prwbc, y = deathn, color = preopdialysis)) + 
# #   Hmisc::histSpikeg(deathn ~ prwbc + preopdialysis, lowess = TRUE, data = df) + 
# #   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
# #   guides(col = guide_legend(nrow = 2))
# 
# p3 <- ggplot(df, aes(x = prwbc, y = deathn, color = preopventilat)) + 
#   Hmisc::histSpikeg(deathn ~ prwbc + preopventilat, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# p4 <- ggplot(df, aes(x = prwbc, y = deathn, color = fsteroid)) + 
#   Hmisc::histSpikeg(deathn ~ prwbc + fsteroid, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# p5 <- ggplot(df, aes(x = prwbc, y = deathn, color = preopsepsis)) + 
#   Hmisc::histSpikeg(deathn ~ prwbc + preopsepsis, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 4))
# 
# p6 <- ggplot(df, aes(x = prwbc, y = deathn, color = preopaki)) + 
#   Hmisc::histSpikeg(deathn ~ prwbc + preopaki, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# marginal_plots[[4]] <- cowplot::plot_grid(p1,p3,p4,p5,p6)
# 
# 
# 
# p1 <- ggplot(df, aes(x = prplate, y = deathn)) + 
#   Hmisc::histSpikeg(deathn ~ prplate, lowess = TRUE, data = df) + 
#   ylim(0,1) + ylab(NULL)
# 
# # p2 <- ggplot(df, aes(x = prplate, y = deathn, color = preopdialysis)) + 
# #   Hmisc::histSpikeg(deathn ~ prplate + preopdialysis, lowess = TRUE, data = df) + 
# #   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
# #   guides(col = guide_legend(nrow = 2))
# 
# p3 <- ggplot(df, aes(x = prplate, y = deathn, color = preopventilat)) + 
#   Hmisc::histSpikeg(deathn ~ prplate + preopventilat, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# p4 <- ggplot(df, aes(x = prplate, y = deathn, color = fsteroid)) + 
#   Hmisc::histSpikeg(deathn ~ prplate + fsteroid, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1+ theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# p5 <- ggplot(df, aes(x = prplate, y = deathn, color = preopsepsis)) + 
#   Hmisc::histSpikeg(deathn ~ prplate + preopsepsis, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 4))
# 
# p6 <- ggplot(df, aes(x = prplate, y = deathn, color = preopaki)) + 
#   Hmisc::histSpikeg(deathn ~ prplate + preopaki, lowess = TRUE, data = df) + 
#   ylim(0,1) + y1 + theme(legend.position = "bottom") + 
#   guides(col = guide_legend(nrow = 2))
# 
# marginal_plots[[5]] <- cowplot::plot_grid(p1,p3,p4,p5,p6)


# dd <- rms::datadist(df)
# options(datadist = 'dd')
# f1 <- rms::lrm(deathn ~ preopdialysis + preopventilat + fsteroid + preopaki + 
#                 pol(prcreat, 2) + prplate + pol(numage, 2) + preopsepsis + pralbum , data = df)
# f1
# anova(f1)

# DT[, table(fsteroid)]
# DT[, table(preopdialysis)]
# DT[, xtabs(~preopdialysis + fsteroid)]
# Hmisc::describe(DT)

# Hmisc::describe(DT)
# Cutoffs : (email from Maria, Feb 23, 2017)
# Age: Can be either <50, 50-60, >60 or <65 and 65 and over  (the highest risk factor in studies is age >75, but I see in our data that the eldest patient is 69)
# Albumin : Less than 1.5, 1.5 to 3, and 3 or more
# WBC : <4, 4-20, 20-49.9, 50 & above
# Preoperative Creatinine <1.13, 1.13 to 2.26, >=2.26
# platelets: <150, >=150

DT[, is.na(numage)] %>% table(useNA = "always")
DT[, min(numage, na.rm = T)]
DT[, max(numage, na.rm = T)]
DT[, numagef := cut(numage, breaks = c(min(numage, na.rm = T),50, 60, 70, 80, max(numage, na.rm = T)), 
                    include.lowest = TRUE, labels = c("[18,50]","(50,60]", "(60,70]", "(70,80]", "(80, 89]"))]
DT[, table(numagef, useNA = "always")]

DT_imp[, numagef := cut(numage, breaks = c(min(numage, na.rm = T),50, 60, 70, 80, max(numage, na.rm = T)), 
                        include.lowest = TRUE, labels = c("[18,50]","(50,60]", "(60,70]", "(70,80]", "(80, 89]"))]
DT_imp[, table(numagef, useNA = "always")]


DT[, is.na(pralbum)] %>% table(useNA = "always")
DT[, hist(pralbum)]
DT[, min(pralbum, na.rm = T)]
DT[, max(pralbum, na.rm = T)]
# DT[, boxplot(pralbum)]
DT[, fivenum(pralbum)]
DT[, pralbumf := cut(pralbum, breaks = c(min(pralbum, na.rm = T), 1.5, 3, max(pralbum, na.rm = T)), include.lowest = TRUE, 
                     labels = c("[1,1.5]","(1.5,3]","(3,4.6]"))]
DT[, table(pralbumf, useNA = "always")]

DT_imp[, pralbumf := cut(pralbum, breaks = c(min(pralbum, na.rm = T), 1.5, 3, max(pralbum, na.rm = T)), include.lowest = TRUE, 
                         labels = c("[1,1.5]","(1.5,3]","(3,4.6]"))]
DT_imp[, table(pralbumf, useNA = "always")]


DT[, is.na(prwbc)] %>% table(useNA = "always")
DT[, hist(prwbc)]
DT[, min(prwbc, na.rm = T)]
DT[, max(prwbc, na.rm = T)]
# DT[, boxplot(prwbc)]
DT[, fivenum(prwbc)]
DT[, prwbcf := cut(prwbc, breaks = c(min(prwbc, na.rm = T), 4, 20, 50, max(prwbc, na.rm = T)), include.lowest = TRUE, 
                   labels = c("[0.1,4]","(4,20]","(20,50]","(50,124.3]"))]
DT[, table(prwbcf, useNA = "always")]
# DT[, prwbcf2 := cut(prwbc, breaks = c(min(prwbc, na.rm = T), 20, max(prwbc, na.rm = T)), include.lowest = TRUE, 
#                    labels = c("<20",">20"))]
# DT[, table(prwbcf2, useNA = "always")]

DT_imp[, prwbcf := cut(prwbc, breaks = c(min(prwbc, na.rm = T), 4, 20, 50, max(prwbc, na.rm = T)), include.lowest = TRUE, 
                       labels = c("[0.1,4]","(4,20]","(20,50]","(50,124.3]"))]
DT_imp[, table(prwbcf, useNA = "always")]



DT[, is.na(prcreat)] %>% table(useNA = "always")
DT[, hist(prcreat)]
DT[, min(prcreat, na.rm = T)]
DT[, max(prcreat, na.rm = T)]
# DT[, boxplot(prcreat)]
DT[, fivenum(prcreat)]
DT[, prcreatf := cut(prcreat, breaks = c(min(prcreat, na.rm = T), 1.13, 2.26, max(prcreat, na.rm = T)), include.lowest = TRUE, 
                     labels = c("[0.3,1.13]","(1.13,2.26]","(2.26,8.7]"))]
DT[, table(prcreatf, useNA = "always")]

DT_imp[, prcreatf := cut(prcreat, breaks = c(min(prcreat, na.rm = T), 1.13, 2.26, max(prcreat, na.rm = T)), include.lowest = TRUE, 
                         labels = c("[0.3,1.13]","(1.13,2.26]","(2.26,8.7]"))]
DT_imp[, table(prcreatf, useNA = "always")]


DT[, is.na(prplate)] %>% table(useNA = "always")
DT[, hist(prplate)]
DT[, min(prplate, na.rm = T)]
DT[, max(prplate, na.rm = T)]
# DT[, boxplot(prplate)]
DT[, fivenum(prplate)]
DT[, prplatef := cut(prplate, breaks = c(min(prplate, na.rm = T), 150, max(prplate, na.rm = T)), include.lowest = TRUE, 
                     labels = c("[17,150]","(150,996]"))]
DT[, table(prplatef, useNA = "always")]
str(DT)
DT[, table(death,deathn)]
DT_imp[, prplatef := cut(prplate, breaks = c(min(prplate, na.rm = T), 150, max(prplate, na.rm = T)), include.lowest = TRUE, 
                         labels = c("[17,150]","(150,996]"))]
DT_imp[, table(prplatef, useNA = "always")]


# rm(df)
df <- as.data.frame(DT)
# df_imp <- as.mids(as.data.frame(DT_imp))
df_imp <- as.data.frame(DT_imp)
df_imp[complete.cases(df_imp),] %>% dim
# rm(DT)



# VAlidation data ---------------------------------------------------------

# did this step only once cause it takes a long time, but also gives the best results
# DT_val <- xlsx::read.xlsx("data/Validation Cohort colectomy only.xls", sheetIndex = 1, stringsAsFactors = FALSE)
# saveRDS(DT_val, file = "data/Validation Cohort colectomy only.rds")

# Age: AGE Column E
# Creatinine: CREPREOP Column DW ( ***NOTE: this is in micromol/L, but NSQIP is in in mg/dL, and 1micromol/L=0.0113 mg/dL)
# Albumin: ALBCOLECT COlumn DT ( (***NOTE: this is in g/L, in NSQIP it's in g/dL and the conversion is 1g/L=0.1g/dL)
# WBC: GBPREOP Colum DV
# Platelets: Not recorded
# Preoperative ventilation: Not recorded
# Preoperative AKI: IRA Column FP
# Preoperative Dialysis: Not recorded
# Immunosuppression: IMMUNO Column P
# Shock: Unfortunately we do not have sufficient detail to describe if these patients were in 
# SIRS/Sepsis but we can say if they were in Septic Shock (they either have CHOCVOLUME (Column DX)=1 or AMIPREOP =1 or RAISONCHX (Column DL)=4
# Outcome: Death= DCD30 Column CW which should be the same as MORTA30 Column FY

DT_val <- readRDS(file = "data/Validation Cohort colectomy only.rds")
DT_val <- as.data.table(DT_val)

val_vars <- c("AGE",
              "CREPREOP", # Creatinine
              "ALBCOLECT", # Albumin
              "GBPREOP", # WBC
              "IRA", # preopaki
              "IMMUNO", # fsteroid
              "CHOCVOLUME", # sepsis
              "AMIPREOP", # sepsis
              "RAISONCHX", # sepsis
              "DCD30") #death

all(val_vars %in% colnames(DT_val))
rm.colnames <- colnames(DT_val)[colnames(DT_val) %ni% val_vars]

DT_val[, (rm.colnames) := NULL]
str(DT_val)

DT_val[, hist(CREPREOP)]
df_imp$prcreat %>% hist

DT_val[, hist(ALBCOLECT)]
df_imp$pralbum %>% hist


DT_val[, `:=`(CREPREOP = CREPREOP * 0.0113)]
DT_val[, `:=`(ALBCOLECT = ALBCOLECT * 0.1)]
DT_val[, table(CHOCVOLUME, useNA = "always")]
DT_val[, table(AMIPREOP, useNA = "always")]
DT_val[, table(RAISONCHX, useNA = "always")]

DT_val[, preopsepsis := 0]
DT_val[, table(preopsepsis, useNA = "always")]


DT_val[CHOCVOLUME == "Y" | AMIPREOP == 1 | RAISONCHX == 4, preopsepsis := 1]
DT_val[, table(preopsepsis, useNA = "always")]

DT_val[, hist(CREPREOP)]
df_imp$prcreat %>% hist

DT_val[, hist(ALBCOLECT)]
df_imp$pralbum %>% hist

DT_val[, table(CHOCVOLUME, AMIPREOP, RAISONCHX, useNA = "always")]


DT_val[, table(IRA, useNA = "always")]
DT_val[, table(IMMUNO, useNA = "always")]
DT_val[, table(GBPREOP, useNA = "always")]
DT_val[, table(DCD30, useNA = "always")]

DT_val[, `:=`(deathn = DCD30, 
          death = factor(DCD30, levels = c(0,1), labels = c("Alive","Dead")),
          #preopdialysis = factor(preopdialysis, levels = c(0,1), labels = c("No Preop Dialysis","Preop Dialysis")),
          # preopventilat = factor(preopventilat, levels = c(0,1), labels = c("Not Ventilated", "Ventilated")),
          preopsepsis = factor(preopsepsis, levels = c(0,1), labels = c("No Shock","Shock")),
          fsteroid = factor(IMMUNO, levels = c("N","Y"), labels = c("Non-immunosuppressed","Immunosuppressed")),
          preopaki = factor(IRA, levels = c(0,1), labels = c("No Preop Aki", "Preop Aki")))]
DT_val

DT_val[, fivenum(GBPREOP)]
DT_val[, max(GBPREOP)]
DT_val[, prwbcf := cut(GBPREOP, breaks = c(min(GBPREOP, na.rm = T), 4, 20, 50, max(GBPREOP, na.rm = T)), include.lowest = TRUE, 
                   labels = c("[0.1,4]","(4,20]","(20,50]","(50,124.3]"))]
DT_val[, table(prwbcf, useNA = "always")]

# final model
# fm_poly_age_creat_pral <- as.formula(paste0("deathn ~ ", 
#                                             paste(c("preopventilat","preopsepsis","fsteroid",
#                                                     "prwbcf","prplatef",
#                                                     "poly(prcreat,2)","poly(numage,2)","poly(pralbum,2)"), 
#                                                   collapse = "+")))

c("deathn", "preopsepsis","fsteroid",
                        "prwbcf",
                        "prcreat","numage","pralbum") %in% colnames(DT_val)

setnames(DT_val, old = c("AGE","CREPREOP","ALBCOLECT"),
         new = c("numage", "prcreat","pralbum"))

c("deathn", "preopsepsis","fsteroid",
  "prwbcf",
  "prcreat","numage","pralbum") %in% colnames(DT_val)


complete.cases(DT_val) %>% sum

describe(DT_val)

df_imp$preopventilat
df_imp$prplatef
DT_val[, preopventilat := "Not Ventilated"]
DT_val[, prplatef := "[17,150]"]

DT_val[, preopventilat := sample(c("Not Ventilated", "Ventilated"), .N, replace = TRUE, prob = c(0.6386, 0.3614))]
DT_val[, prplatef := sample(c("[17,150]", "(150,996]"), .N, replace = TRUE, prob = c(0.2573, 0.7427))]

DT_val[, table(preopventilat, useNA = "always")]
DT_val[, table(prplatef, useNA = "always")]
